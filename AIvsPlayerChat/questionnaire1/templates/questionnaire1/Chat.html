{% extends "global/Page.html" %}
{% load staticfiles otree_tags%}
{% block title %}
    Chat Bot
{% endblock %}
{% block content %}

    <div class="container">
        <h4 class="jumbotron-heading text-xs-center">Chat Room for chat with bot</h4>
        <p class="lead text-xs-center">
          This page allows you to chat with a human like chat bot.
        </p>
        <input type="hidden" id="player" name="player" value={{ player }}>
        <input type="hidden" id="session" name="session" value={{ session }}>
        <hr class="my-2">
        <div class="row">
          <div class="col-xs-6 offset-xs-3">
            <ul class="list-group chat-log js-chat-log">
            </ul>
            <div class="input-group input-group-lg mt-1">
              <input id='textbox' type="text" class="form-control js-text" placeholder="Type something to begin..." required/>
              <span class="input-group-btn">
                <button id='say' class="btn btn-primary js-say" type="button">Say</button>
              </span>
            </div>
          </div>
        </div>
      </div>
    <script src="{% static 'js/jquery.js' %}"></script>
    <script src="{% static 'js/js.cookie.js' %}"></script>
    <script src="{% static 'js/bootstrap.js' %}"></script>
    <script type='text/javascript' src="http://cdnjs.cloudflare.com/ajax/libs/jquery-ajaxtransport-xdomainrequest/1.0.1/jquery.xdomainrequest.min.js"></script>

    <script>

        var csrftoken = Cookies.get('csrftoken');

        function csrfSafeMethod(method) {
            return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
        }

        $.ajaxSetup({
            beforeSend: function(xhr, settings) {
                if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                    xhr.setRequestHeader("X-CSRFToken", csrftoken);
                }
            }
        });

        var $chatlog = $('.js-chat-log');
        var $input = $('.js-text');
        var $sayButton = $('.js-say');

        function createRow(text) {
            var $row = $('<li class="list-group-item"></li>');
            $row.text(text);
            $chatlog.append($row);
        }

        function send(id, data){
            var xhr = new XMLHttpRequest();
            xhr.open('POST', 'http://10.25.182.227:5000/', true);
            xhr.setRequestHeader('Content-Type', 'application/json');
            xhr.send(JSON.stringify({
                "round": "0",
                "session": document.getElementById("session").value,
                "id": id,
                "text": data
            }));
        }

        function say() {
            var text = $input.val();
            var id = document.getElementById("player").value;
            send("Player"+id, text);
            createRow(text);
            $input.val('');
            var xhr = new XMLHttpRequest();
            xhr.open('POST', 'http://10.25.182.227:4000/', true);
            xhr.setRequestHeader('Content-Type', 'text/plain');
            xhr.send(text);
            xhr.onreadystatechange = function () {
                if (xhr.readyState === XMLHttpRequest.DONE) {
                    createRow(xhr.responseText);
                    send("Bot"+id, xhr.responseText);
                    $chatlog[0].scrollTop = $chatlog[0].scrollHeight;
                }
            };
        }

        $sayButton.click(function() {
            say();
        });

        $(document).keypress(function (e) {
            if (e.which === 13) {
                e.preventDefault();
                say();
            }
        });

    </script>
{% endblock %}